# Sleep Disorder Risk Prediction — Project Repository

## Overview
This project predicts **high risk** vs **low risk** for sleep disorders using lifestyle and basic health features from NHANES survey data. The pipeline uses NHANES cycles **2005–2016** (selected because those cycles consistently include diagnostic sleep questionnaire items), merges cycles, engineers features, trains models, and exposes a lightweight Streamlit UI for inference and personalized recommendations.

## What this repo contains
- `src/check_nhanes_downloads.py` — downloader that fetches NHANES XPT files (2005–2016), converts to CSV, and writes per-cycle JSON reports about variable presence.
- `src/merge_and_engineer.py` — loads converted CSVs, harmonizes variable names across cycles, merges data on `SEQN`, constructs the target and engineered features, and writes `data/processed/merged_clean.csv`.
- `notebooks/01_data_prep.ipynb` — end-to-end Jupyter notebook (data download, conversion, merge, baseline training, evaluation, SHAP explainability, model saving). **Run interactively**.
- `streamlit_app.py` — minimal Streamlit UI template for model inference and recommendations.
- `requirements.txt` — pinned package list for reproducibility.
- `README.md` — this file (you are reading it).

## Data provenance & license
Data are obtained from the U.S. Centers for Disease Control and Prevention (CDC) — NHANES public-use datasets. NHANES datasets are free for public use. For details and documentation, visit: https://www.cdc.gov/nchs/nhanes/index.htm

We use cycles: 2005-2006, 2007-2008, 2009-2010, 2011-2012, 2013-2014, 2015-2016. Confirm variable presence per cycle by inspecting `reports/<cycle>_report.json` generated by the downloader before merging and training.

## Target definition
A participant is labeled **high risk (1)** if any of the following apply:
- Doctor-diagnosed sleep disorder (`SLQ060 == 1`) where available.
- Short or long sleep: `SLD012 < 7` hours or `SLD012 > 9` hours.
- Frequent excessive sleepiness: `SLQ120 >= 16` times/month.

If a participant has `7 <= SLD012 <= 9` and no diagnostic indicator, label as **low risk (0)**. Participants with insufficient information are dropped from model training.

## Main engineered features
- Non-modifiable: `age`, `sex`.
- Modifiable / lifestyle: `BMI`, `exercise_min_week`, `calories_day`, `fiber_g_day`, `added_sugar_g_day`, `caffeine_mg_day`, `alcohol_drinks_week`, `current_smoker`, `depression_score`, `systolic_bp`, `diastolic_bp`.

## Modeling & evaluation
- Baseline models: Logistic Regression (L1), Random Forest, XGBoost. Hyperparameter tuning via GridSearch/Optuna recommended.
- Key metrics: ROC-AUC, PR-AUC, sensitivity, specificity, calibration, and confusion matrix for thresholded decisions.
- Explainability: SHAP (TreeExplainer) to report global and local feature importances and counterfactual recommendation simulations.

## Reproducibility & how to run
1. Create virtual environment and install dependencies:
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```
2. Download + convert NHANES files (this will write XPTs + CSVs and produce `reports/`):
```bash
python src/check_nhanes_downloads.py --out data/raw --report reports --convert
```
3. Inspect `reports/` to confirm key variables exist in each cycle.
4. Merge and engineer features:
```bash
python src/merge_and_engineer.py --input data/raw --output data/processed/merged_clean.csv
```
5. Open the notebook `notebooks/01_data_prep.ipynb` and follow cells to train baseline model, evaluate, and save artifacts to `models/`.
6. Run the Streamlit UI (after you saved model & scaler to `models/`):
```bash
streamlit run streamlit_app.py
```

## Limitations & ethics
- Predicts risk, not diagnosis. Not a replacement for polysomnography or clinical judgment.
- NHANES is U.S. population; generalizability may be limited outside the U.S.
- Self-reported measures can include recall and reporting bias.
- Ensure privacy and do not attempt re-identification of participants.

## Contact & citation
Prepared by the Lightdrift team. Cite this repo when using the code. For questions, contact: paicualexandru44@gmail.com
